

æˆ‘ä»¬ä¼¼ä¹Žä»¥å‰å·²ç»è¾¾æˆäº†å…±è¯†ï¼Œâ€œå•ä¾‹æ¨¡å¼å¾ˆå¥½ç”¨ï¼Œä½†ä¸èƒ½æ»¥ç”¨â€ã€‚ä½†æ˜¯åœ¨Appleå’Œç¬¬ä¸‰æ–¹Swiftæ¡†æž¶ä¸­å¼€å‘äººå‘˜è¿˜åœ¨å¤§é‡çš„ä½¿ç”¨å®ƒã€‚

> "å•ä¾‹å°±æ˜¯æŠ«ç€ç¾Šçš®çš„å…¨å±€çŠ¶æ€" -- MiÅ¡ko Hevery 

ä»Šå¤©æˆ‘ä»¬çœ‹ä¸€ä¸‹å•ä¾‹ä½¿ç”¨çš„ç¡®åˆ‡é—®é¢˜ï¼Œå¹¶æŽ¢ç´¢å¦‚ä½•é¿å…æ»¥ç”¨ã€‚

### ä¸ºä»€ä¹ˆå•ä¾‹å¦‚æ­¤å—æ¬¢è¿Ž

å•ä¾‹æ¨¡å¼ä¸ºä»€ä¹ˆåœ¨iOSå¼€å‘ä¸­è¿™ä¹ˆæµè¡Œå‘¢ï¼Ÿå¦‚æžœå¤§å¤šæ•°å¼€å‘äººå‘˜éƒ½åŒæ„åº”é¿å…æ»¥ç”¨å®ƒä»¬ï¼Œä¸ºä»€ä¹ˆä»åœ¨è¢«å¤§é‡ä½¿ç”¨ï¼Ÿ

æˆ‘è®¤ä¸ºæœ‰ä¸¤ä¸ªåŽŸå› ã€‚é¦–å…ˆæœ€ä¸»è¦åŽŸå› æ˜¯Appleå†…éƒ¨éƒ½åœ¨ç»å¸¸ä½¿ç”¨å®ƒï¼Œå¤§å®¶å°±ä¼šæŠŠè‹¹æžœçš„åšæ³•å½“æˆâ€œæœ€ä½³å®žçŽ°â€æ¨¡ä»¿ã€æµä¼ ã€‚

ç¬¬äºŒä¸ªåŽŸå› æ˜¯å®ƒç¡®å®žæä¾›äº†ä¾¿åˆ©ã€‚å•ä¾‹é€šå¸¸ä¸ºæˆ‘ä»¬è®¿é—®æ ¸å¿ƒçš„å€¼å’Œå¯¹è±¡æä¾›äº†æ·å¾„ï¼Œå› ä¸ºå®ƒä»¬åŸºæœ¬ä¸Šå¯ä»¥ä»Žä»»ä½•åœ°æ–¹è®¿é—®ã€‚çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬æƒ³åœ¨`ProfileViewController`ä¸­æ˜¾ç¤ºå½“å‰ç™»å½•çš„ç”¨æˆ·åï¼Œå¹¶åœ¨ç‚¹å‡»æŒ‰é’®æ—¶æ³¨é”€ç”¨æˆ·ï¼š

```swift
class ProfileViewController: UIViewController {
    private lazy var nameLabel = UILabel()

    override func viewDidLoad() {
        super.viewDidLoad()
        nameLabel.text = UserManager.shared.currentUser?.name
    }

    private func handleLogOutButtonTap() {
        UserManager.shared.logOut()
    }
}
```

åƒä¸Šé¢è¿™æ ·æŠŠç”¨æˆ·ä¿¡æ¯å’Œè´¦æˆ·å¤„ç†åŠŸèƒ½å°è£…åœ¨`UserManager`å•ä¾‹ä¸­ï¼Œç¡®å®žéžå¸¸æ–¹ä¾¿ï¼ˆè€Œä¸”å¾ˆå¸¸è§ï¼ï¼‰ã€‚ é‚£ä¹ˆä½¿ç”¨è¿™ç§æ¨¡å¼åˆ°åº•æœ‰ä»€ä¹ˆä¸å¥½å‘¢ï¼Ÿ ðŸ¤”

### å•ä¾‹æ¨¡å¼æœ‰ä»€ä¹ˆä¸å¥½ï¼Ÿ

åœ¨è®¨è®ºè¯¸å¦‚æ¨¡å¼å’Œæž¶æž„ä¹‹ç±»çš„é—®é¢˜æ—¶ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“é™·å…¥è¿‡äºŽç†è®ºåŒ–çš„é™·é˜±ã€‚ä½¿ä»£ç åœ¨ç†è®ºä¸Šæ˜¯â€œæ­£ç¡®çš„â€å¹¶éµå¾ªæ‰€æœ‰æœ€ä½³å®žè·µå’ŒåŽŸåˆ™ï¼Œè¿™æ˜¯å¾ˆå¥½çš„åšæ³•ã€‚ä½†çŽ°å®žå¾€å¾€å¾ˆæ®‹é…·ï¼Œæˆ‘ä»¬éœ€è¦è§†æƒ…å†µè€Œå®šã€‚



é‚£ä¹ˆå•ä¾‹æ¨¡å¼é€šå¸¸ä¼šå¼•èµ·ä»€ä¹ˆå…·ä½“é—®é¢˜ï¼Œä¸ºä»€ä¹ˆè¦é¿å…è¿™äº›é—®é¢˜å‘¢ï¼Ÿæˆ‘å€¾å‘äºŽé¿å…ä½¿ç”¨å•ä¾‹çš„ä¸‰ä¸ªä¸»è¦åŽŸå› æ˜¯ï¼š

- **å®ƒä»¬æ˜¯å…¨å±€å¯å˜çš„å…±äº«çŠ¶æ€**ã€‚å®ƒä»¬çš„çŠ¶æ€ä¼šè‡ªåŠ¨åœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºä¸­å…±äº«ï¼Œå¹¶ä¸”å½“çŠ¶æ€è¢«æ„å¤–æ›´æ”¹æ—¶ï¼Œé€šå¸¸ä¼šå‘ç”Ÿé”™è¯¯ã€‚æ˜“é”™ã€‚
- **å•ä¾‹å’Œä¾èµ–äºŽå®ƒä»¬çš„ä»£ç ä¹‹é—´çš„å…³ç³»é€šå¸¸æ²¡æœ‰å¾ˆå¥½åœ°å®šä¹‰**ã€‚ç”±äºŽå•ä¾‹éžå¸¸æ–¹ä¾¿ä¸”æ˜“äºŽè®¿é—®ï¼Œå¹¿æ³›ä½¿ç”¨å®ƒä»¬é€šå¸¸ä¼šå¯¼è‡´å¾ˆéš¾ç»´æŠ¤ï¼Œåƒâ€œæ„å¤§åˆ©é¢æ¡å¼ä»£ç â€ï¼Œè€Œå¯¹è±¡ä¹‹é—´æ²¡æœ‰æ˜Žç¡®çš„åˆ†éš”ã€‚éšæ€§ä¾èµ–ã€‚
- **ç®¡ç†å…¶ç”Ÿå‘½å‘¨æœŸå¯èƒ½å¾ˆæ£˜æ‰‹**ã€‚ç”±äºŽå•ä¾‹åœ¨åº”ç”¨ç¨‹åºçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­éƒ½å¤„äºŽæ´»åŠ¨çŠ¶æ€ï¼Œå› æ­¤å¯¹å…¶è¿›è¡Œç®¡ç†å¯èƒ½éžå¸¸å›°éš¾ï¼Œå¹¶ä¸”å®ƒä»¬é€šå¸¸ä¾é å¯èƒ½ä¸ºç©ºçš„ï¼ˆoptionalï¼‰çš„å€¼ã€‚è¿™ä¹Ÿä½¿å¾—ä¾èµ–å•ä¾‹çš„ä»£ç çœŸçš„å¾ˆéš¾æµ‹è¯•ï¼Œå› ä¸ºåœ¨æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹ä¸­éƒ½ä¸èƒ½è½»æ˜“ä»Žâ€œåˆå§‹çŠ¶æ€â€å¼€å§‹ã€‚ä¸ä¾¿äºŽæµ‹è¯•ã€‚

> è¯‘è€…è¡¥å……ï¼š
>
> 1. ä»…ä»…ä½¿ç”¨ä¸€æ¬¡çš„æ¨¡å—ï¼Œå¯ä»¥ä¸ä½¿ç”¨å•ä¾‹ï¼Œå› ä¸ºå®ƒä¼šä¸€ç›´å ç”¨å†…å­˜ï¼Œ**å¯ä»¥é‡‡ç”¨åœ¨å¯¹åº”çš„å‘¨æœŸå†…ç»´æŠ¤æˆå‘˜å®žä¾‹å˜é‡è¿›è¡Œæ›¿æ¢**ã€‚
> 2. å•ä¾‹ä¿å­˜ç”¨æˆ·æ•°æ®ï¼Œé€€å‡ºç™»é™†æ—¶éœ€è¦æ¸…æ¥šï¼Œè¿™æ—¶å¦‚æžœæœ‰å¼‚æ­¥å­˜å‚¨ä»»åŠ¡å°±å¯èƒ½äº§ç”Ÿè„æ•°æ®ã€‚



åœ¨ä¹‹å‰çš„`ProfileViewController`ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥çœ‹åˆ°è¿™3ä¸ªé—®é¢˜çš„è¿¹è±¡ã€‚æˆ‘ä»¬ä¸èƒ½æ¸…é™¤çš„åˆ¤æ–­é¡µé¢æ˜¯ä¾èµ–`UserManager`çš„ï¼Œè€Œä¸”å•ä¾‹åŒ…å«ä¸€ä¸ªå¯èƒ½ä¸ºç©ºçš„å¯¹è±¡currentUserï¼Œç¼–è¯‘æ—¶å¹¶ä¸èƒ½æ£€æµ‹å‡ºæ¥ï¼Œå³åœ¨é¡µé¢å±•ç¤ºæ˜¯å¯èƒ½currentUserä¸ºnilã€‚çœ‹èµ·æ¥å°±æ˜¯ä¸€ä¸ªç­‰å¾…è§¦å‘çš„BugðŸ˜¬ã€‚

### ä¾èµ–æ³¨å…¥

ä¸Žå…¶è®©ProfileViewControlleré€šè¿‡å•ä¾‹è®¿é—®ä¾èµ–æ•°æ®ï¼Œä¸å¦‚å°†å®ƒä»¬æ³¨å…¥å…¶`init`æ–¹æ³•ä¸­ã€‚ åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†ç”¨æˆ·ä¿¡æ¯ä»¥åŠå¯ç”¨äºŽæ‰§è¡Œæ³¨é”€æ“ä½œçš„LogOutServiceä½œä¸ºå¿…ä¼ å‚æ•°ï¼š

```swift
class ProfileViewController: UIViewController {
    private let user: User
    private let logOutService: LogOutService
    private lazy var nameLabel = UILabel()

    init(user: User, logOutService: LogOutService) {
        self.user = user
        self.logOutService = logOutService
        super.init(nibName: nil, bundle: nil)
    }

    override func viewDidLoad() {
        super.viewDidLoad()
        nameLabel.text = user.name
    }

    private func handleLogOutButtonTap() {
        logOutService.logOut()
    }
}
```

ç»“æžœæ›´åŠ æ¸…æ™°ï¼Œæ›´æ˜“äºŽç®¡ç†ã€‚ çŽ°åœ¨ï¼Œæˆ‘ä»¬çš„ä»£ç å®‰å…¨åœ°ä¾èµ–å§‹ç»ˆå­˜åœ¨çš„Modelï¼Œå¹¶ä¸”å…·æœ‰æ¸…æ™°çš„APIæ‰§è¡Œæ³¨é”€æ“ä½œã€‚ é€šå¸¸ï¼Œå°†å„ç§å•ä¾‹å’Œç®¡ç†å™¨ï¼ˆmanagersï¼‰é‡æž„ä¸ºæ¸…æ™°ã€åˆ†å¼€çš„`Services`æ˜¯åœ¨`App`æ ¸å¿ƒå¯¹è±¡ä¹‹é—´åˆ›å»ºæ›´æ¸…æ™°å…³ç³»çš„ä¸€ç§å¥½æ–¹æ³•ã€‚

### Services

ä½œä¸ºç¤ºä¾‹ï¼Œè®©æˆ‘ä»¬ä»”ç»†çœ‹çœ‹å¦‚ä½•å®žçŽ°`LogOutService`ã€‚ å®ƒä¹Ÿå°†â€œä¾èµ–é¡¹â€ç”¨äºŽå…¶åŸºç¡€æœåŠ¡ï¼Œå¹¶æä¾›äº†ä¸€ä¸ªæ¼‚äº®ä¸”å®šä¹‰æ˜Žç¡®çš„APIï¼Œä»…ç”¨äºŽåšä¸€ä»¶äº‹ã€æ³¨é”€ã€‘ã€‚

```swift
class LogOutService {
    private let user: User
    private let networkService: NetworkService
    private let navigationService: NavigationService

    init(user: User,
         networkService: NetworkService,
         navigationService: NavigationService) {
        self.user = user
        self.networkService = networkService
        self.navigationService = navigationService
    }

    func logOut() {
        networkService.request(.logout(user)) { [weak self] in
            self?.navigationService.showLoginScreen()
        }
    }
}
```

### é‡æž„

ä»Žå¤§é‡ä½¿ç”¨å•ä¾‹æ”¹æˆå……åˆ†åˆ©ç”¨Servicesçš„ä»£ç ï¼Œä¾èµ–é¡¹æ³¨å…¥å’Œæœ¬åœ°çŠ¶æ€å¯èƒ½éžå¸¸å›°éš¾ä¸”è€—æ—¶ã€‚ èŠ±è´¹æ—¶é—´ä¸è¯´ï¼Œæœ‰æ—¶å¯èƒ½ç”šè‡³éœ€è¦å·¨å¤§çš„é‡æž„ã€‚

ä¸ç”¨æ‹…å¿ƒï¼Œâ€œä½¿ç”¨åè®®æ¥ç§»é™¤å•ä¾‹â€çš„æ–¹å¼å¯ä»¥åŠ©ä½ ä¸€è‡‚ä¹‹åŠ›ã€‚

ä¸éœ€è¦ä¸€æ¬¡é‡æž„æ‰€æœ‰å•ä¾‹å¹¶åˆ›å»ºæ–°çš„`Service`ç±»ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°å°†`Service`å®šä¹‰ä¸ºåè®®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```swift
protocol LogOutService {
    func logOut()
}

protocol NetworkService {
    func request(_ endpoint: Endpoint, completionHandler: @escaping () -> Void)
}

protocol NavigationService {
    func showLoginScreen()
    func showProfile(for user: User)
    ...
}
```



ç„¶åŽï¼Œæˆ‘ä»¬å¯ä»¥è®©å•ä¾‹éµå¾ªæˆ‘ä»¬çš„æ–°æœåŠ¡åè®®ï¼Œä»Žè€Œè½»æ¾åœ°å°†å•ä¾‹ä½œä¸ºâ€œæœåŠ¡â€è¿›è¡Œæ”¹é€ ã€‚ åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ç”šè‡³ä¸éœ€è¦è¿›è¡Œä»»ä½•å®žçŽ°ä¸Šçš„ä¿®æ”¹ï¼Œåªéœ€å°†å•ä¾‹ä½œä¸ºæœåŠ¡ä¼ é€’å³å¯ã€‚

åŒæ ·çš„æŠ€æœ¯ä¹Ÿå¯ä»¥ç”¨äºŽæ”¹é€ æˆ‘ä»¬Appä¸­çš„å…¶ä»–æ ¸å¿ƒå¯¹è±¡ï¼Œè€Œè¿™äº›æ ¸å¿ƒå¯¹è±¡å¯èƒ½ä¸€ç›´ä»¥â€œå•ä¾‹æ¨¡å¼â€çš„æ–¹å¼ä½¿ç”¨ï¼Œä¾‹å¦‚ä½¿ç”¨`AppDelegate`è¿›è¡Œé¡µé¢å¯¼èˆªã€‚

```swift
extension UserManager: LoginService, LogOutService {}

extension AppDelegate: NavigationService {
    func showLoginScreen() {
        navigationController.viewControllers = [
            LoginViewController(
                loginService: UserManager.shared,
                navigationService: self
            )
        ]
    }

    func showProfile(for user: User) {
        let viewController = ProfileViewController(
            user: user,
            logOutService: UserManager.shared
        )

        navigationController.pushViewController(viewController, animated: true)
    }
}
```



çŽ°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨â€œä¾èµ–é¡¹æ³¨å…¥â€å’Œ`Services`å¼€å§‹æŠŠæ‰€æœ‰çš„`view controller`ä¸­çš„å•ä¾‹åŽ»æŽ‰äº†ã€‚æ— éœ€è¿›è¡Œå¤§é‡çš„é‡æž„å’Œä¿®æ”¹ðŸŽ‰ï¼

### æ€»ç»“

å•ä¾‹å¹¶ä¸æ˜¯æ— å¯æ•‘è¯ï¼Œä½†æ˜¯åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œå•ä¾‹ç¡®å®žå¸¦æ¥äº†ä¸€ç³»åˆ—é—®é¢˜ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨å¯¹è±¡ä¹‹é—´åˆ›å»ºæ›´æ˜Žç¡®å®šä¹‰çš„å…³ç³»å¹¶ä½¿ç”¨ä¾èµ–æ³¨å…¥æ¥é¿å…è¿™äº›é—®é¢˜ã€‚



> ä½œè€… johnsundell
> ç¿»è¯‘æ•´ç†ï¼šä¹Coding
> å‚è€ƒï¼š
> https://satanwoo.github.io/2016/04/11/dispatch-once/
> https://objccn.io/issue-13-2/
> https://www.swiftbysundell.com/articles/avoiding-singletons-in-swift/



![image](https://upload-images.jianshu.io/upload_images/1159872-d2c50de82278e1cc?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
