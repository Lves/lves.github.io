

å€¼ç±»å‹å’Œå¼•ç”¨ç±»å‹æ˜¯Swiftä¸­çš„æ ¸å¿ƒæ¦‚å¿µã€‚ æ¯‹åº¸ç½®ç–‘ï¼Œäº†è§£å®ƒä»¬æ˜¯æ¯ä½Swiftå¼€å‘äººå‘˜çš„åŸºç¡€ã€‚ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®ºä¸‹é¢çš„é—®é¢˜ï¼š

- å€¼ç±»å‹å’Œå¼•ç”¨ç±»å‹çš„æ¦‚å¿µ
- ä»–ä»¬åœ¨å†…å­˜ä¸­æ—¶å¦‚ä½•å­˜å‚¨çš„ï¼Ÿ
- å€¼ç±»å‹å’Œå¼•ç”¨ç±»å‹åˆ†åˆ«æœ‰å“ªäº›è¡¨ç°ï¼Ÿ
- å¦‚æœå°†ä¸¤è€…æ··åˆä½¿ç”¨ä¼šæ€æ ·ï¼Ÿ
- ä»€ä¹ˆæ—¶å€™ä½¿ç”¨å€¼ç±»å‹ï¼Œä»€ä¹ˆæ—¶å€™ä½¿ç”¨å¼•ç”¨ç±»å‹ï¼Ÿ

### å®šä¹‰å€¼ç±»å‹å’Œå¼•ç”¨ç±»å‹

Swiftæœ‰ä¸‰ç§å£°æ˜ç±»å‹çš„æ–¹å¼ï¼š`class`ï¼Œ`struct`å’Œ`enum`ã€‚ å®ƒä»¬å¯ä»¥åˆ†ä¸ºå€¼ç±»å‹ï¼ˆstructå’Œenumï¼‰å’Œå¼•ç”¨ç±»å‹ï¼ˆclassï¼‰ã€‚ å®ƒä»¬åœ¨å†…å­˜ä¸­çš„å­˜å‚¨æ–¹å¼ä¸åŒå†³å®šå®ƒä»¬ä¹‹é—´çš„åŒºåˆ«ï¼š

-  `å€¼ç±»å‹`å­˜å‚¨åœ¨æ ˆåŒºã€‚ æ¯ä¸ªå€¼ç±»å‹å˜é‡éƒ½æœ‰å…¶è‡ªå·±çš„æ•°æ®å‰¯æœ¬ï¼Œå¹¶ä¸”å¯¹ä¸€ä¸ªå˜é‡çš„æ“ä½œä¸ä¼šå½±å“å¦ä¸€ä¸ªå˜é‡ã€‚

- å¼•ç”¨ç±»å‹å­˜å‚¨åœ¨å…¶ä»–ä½ç½®ï¼ˆå †åŒºï¼‰ï¼Œæˆ‘ä»¬åœ¨å†…å­˜ä¸­æœ‰ä¸€ä¸ªæŒ‡å‘è¯¥ä½ç½®çš„å¼•ç”¨ã€‚ å¼•ç”¨ç±»å‹çš„å˜é‡å¯ä»¥æŒ‡å‘ç›¸åŒç±»å‹çš„æ•°æ®ã€‚ å› æ­¤ï¼Œå¯¹ä¸€ä¸ªå˜é‡è¿›è¡Œçš„æ“ä½œä¼šå½±å“å¦ä¸€å˜é‡æ‰€æŒ‡å‘çš„æ•°æ®ã€‚

  

### ä»æ€§èƒ½å‡ºå‘

å¯¼è‡´`Swift`ç»“æ„ä½“ï¼ˆå’Œæšä¸¾ï¼‰ä¸ç±»çš„æ€§èƒ½å·®å¼‚çš„ä¸‰ä¸ªç»´åº¦æ˜¯ï¼š

1. å¤åˆ¶æ¶ˆè€—çš„æˆæœ¬ï¼›
2. åˆ›å»ºå’Œé”€æ¯æ—¶èŠ±è´¹æˆæœ¬ï¼›
3. å¼•ç”¨è®¡æ•°é€ æˆçš„æˆæœ¬ï¼›

ä¸‹é¢æˆ‘ä»¬å¯èƒ½ä¼šç»å¸¸è®¨è®ºå†…å­˜ï¼Œå› æ­¤è¯·ç¡®ä¿ä½ äº†è§£ä»€ä¹ˆæ˜¯å†…å­˜ä»¥åŠå†…å­˜æ˜¯å¦‚ä½•å­˜å‚¨æ•°æ®çš„ã€‚



### å†…å­˜æ®µ

å†…å­˜å¯ä»¥ç†è§£ä¸ºå­—èŠ‚çš„é›†åˆã€‚å­—èŠ‚åœ¨å†…å­˜ä¸­æœ‰åºæ’åˆ—ï¼Œæ¯ä¸ªå­—èŠ‚éƒ½æœ‰è‡ªå·±çš„åœ°å€ã€‚ æ‰€æœ‰åœ°å€çš„èŒƒå›´ç§°ä¸ºåœ°å€ç©ºé—´ã€‚

`iOS`åº”ç”¨ç¨‹åºçš„åœ°å€ç©ºé—´åœ¨é€»è¾‘ä¸Šç”±å››ä¸ªéƒ¨åˆ†ç»„æˆï¼šä»£ç æ®µï¼Œæ•°æ®æ®µï¼Œæ ˆåŒºå’Œå †åŒºï¼š


![1](https://upload-images.jianshu.io/upload_images/1159872-0bfc3a3e581ba358?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

ä»£ç æ®µåŒ…å«æ„æˆAppå¯æ‰§è¡Œä»£ç çš„æœºå™¨æŒ‡ä»¤ã€‚ å®ƒæ˜¯ç”±ç¼–è¯‘å™¨é€šè¿‡å°†Swiftä»£ç è½¬æ¢ä¸ºæœºå™¨ä»£ç è€Œäº§ç”Ÿçš„ã€‚ è¯¥æ®µæ˜¯åªè¯»çš„ï¼Œå¹¶å ç”¨å›ºå®šä¸å˜çš„ç©ºé—´ã€‚



æ•°æ®æ®µå­˜å‚¨Swifté™æ€å˜é‡ï¼Œå¸¸é‡å’Œç±»å‹å…ƒæ•°æ®ã€‚ ç¨‹åºå¯åŠ¨æ—¶æ‰€æœ‰éœ€è¦åˆå§‹å€¼çš„å…¨å±€æ•°æ®éƒ½åœ¨æ­¤å¤„ã€‚ 



æ ˆåŒºå­˜å‚¨ä¸´æ—¶æ•°æ®ï¼šæ–¹æ³•çš„å‚æ•°å’Œå±€éƒ¨å˜é‡ã€‚ æ¯æ¬¡æˆ‘ä»¬è°ƒç”¨ä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œéƒ½ä¼šåœ¨æ ˆä¸Šåˆ†é…ä¸€å—æ–°çš„å†…å­˜ã€‚ è¯¥æ–¹æ³•é€€å‡ºæ—¶ï¼Œå°†é‡Šæ”¾è¯¥å†…å­˜ã€‚ é™¤ç‰¹æ®Šæƒ…å†µï¼ˆä¸‹é¢ä¼šè®²ï¼‰ï¼Œæ‰€æœ‰Swiftå€¼ç±»å‹éƒ½åœ¨æ­¤å¤„ã€‚

å †åŒºå­˜å‚¨å…·æœ‰ç”Ÿå­˜æœŸçš„å¯¹è±¡ã€‚ è¿™äº›éƒ½æ˜¯Swiftå¼•ç”¨ç±»å‹ï¼Œè¿˜æœ‰ä¸€äº›å€¼ç±»å‹çš„æƒ…å†µã€‚ å †å’Œæ ˆæœç€å½¼æ­¤å¢é•¿**å †åŒºçš„åˆ†é…ä¸€èˆ¬æŒ‰ç…§åœ°å€ä»å°åˆ°å¤§è¿›è¡Œï¼Œè€Œæ ˆåŒºçš„åˆ†é…ä¸€èˆ¬æŒ‰ç…§åœ°å€ä»å¤§åˆ°å°è¿›è¡Œåˆ†é…**ã€‚

> ä¸€èˆ¬Swiftå€¼ç±»å‹åœ¨æ ˆä¸Šåˆ†é…ã€‚ å¼•ç”¨ç±»å‹åœ¨å †ä¸Šåˆ†é…ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»ç ”ç©¶äº†å†…å­˜æ®µçš„å·¥ä½œåŸç†ï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å†…å­˜ä¸­çš„å†…å®¹æ˜¯å¦‚ä½•å­˜å‚¨çš„ã€‚



### å †ä¸æ ˆåˆ†é…çš„æˆæœ¬

æ ˆåŒºå†…å­˜åˆ†é…å’Œé”€æ¯çš„å·¥ä½œåŸç†ä¸æ•°æ®ç»“æ„ä¸­çš„æ ˆç›¸åŒã€‚ ä½ åªèƒ½ä»æ ˆé¡¶å‹æ ˆæˆ–å‡ºæ ˆã€‚ æŒ‡å‘æ ˆé¡¶çš„æŒ‡é’ˆè¶³ä»¥å®ç°è¿™ä¸¤ä¸ªæ“ä½œã€‚ å› æ­¤ï¼Œæ ˆæŒ‡é’ˆå¯ä»¥è…¾å‡ºç©ºé—´æ¥åˆ†é…å…¶ä»–æ›´å¤šçš„å†…å­˜ã€‚ å½“å‡½æ•°æ‰§è¡Œå®Œé€€å‡ºæ—¶ï¼Œæˆ‘ä»¬å°†æ ˆæŒ‡é’ˆå¢åŠ åˆ°è°ƒç”¨æ­¤æ–¹æ³•ä¹‹å‰çš„ä½ç½®ã€‚ï¼ˆä¸ºä»€ä¹ˆå¢åŠ æ‰èƒ½å›åˆ°è°ƒç”¨ä¹‹å‰çš„åœ°å€ï¼Œåˆšè¯´äº†æ ˆæ˜¯ä»å¤§åˆ°å°è¿›è¡Œåˆ†é…çš„ï¼‰

> æ ˆåˆ†é…å’Œé‡Šæ”¾çš„æˆæœ¬ç›¸å½“äºæ•´æ•°å¤åˆ¶çš„æˆæœ¬ã€WWDC-416ã€‘



å †åˆ†é…è¿‡ç¨‹æ¶‰åŠçš„ä¸œè¥¿å¾ˆå¤šã€‚ æˆ‘ä»¬å¿…é¡»æœç´¢å †åŒºä»¥æ‰¾åˆ°é€‚åˆå®ƒå¤§å°çš„ç©ºå†…å­˜å—ã€‚ æˆ‘ä»¬è¿˜å¿…é¡»åŒæ­¥å †ï¼Œå› ä¸ºå¤šä¸ªçº¿ç¨‹å¯èƒ½åŒæ—¶åœ¨å…¶ä¸­åˆ†é…å†…å­˜ã€‚ ä¸ºäº†ä»å †ä¸­é‡Šæ”¾å†…å­˜ï¼Œæˆ‘ä»¬å¿…é¡»å°†è¯¥å†…å­˜é‡æ–°æ’å…¥é€‚å½“çš„ä½ç½®ã€‚

> å †åˆ†é…å’Œé‡Šæ”¾çš„æˆæœ¬æ¯”æ ˆè¦å¤§å¾—å¤š

é€šå¸¸å€¼ç±»å‹å’Œå¼•ç”¨ç±»å‹åˆ†åˆ«åœ¨æ ˆå’Œå †ä¸Šåˆ†é…ï¼Œä½†æ˜¯è¿™ä¸ªè§„åˆ™æœ‰ä¸€äº›ä¾‹å¤–æƒ…å†µéœ€è¦æ³¨æ„ã€‚

### Swift å¼•ç”¨ç±»å‹å…³äºæ ˆçš„ä¼˜åŒ–

å½“å¼•ç”¨ç±»å‹çš„å¤§å°å›ºå®šæˆ–å¯ä»¥é¢„æµ‹ç”Ÿå­˜æœŸçš„æ—¶å€™ï¼ŒSwiftç¼–è¯‘å™¨å¯èƒ½ä¼šå°†å¼•ç”¨ç±»å‹åˆ†é…åˆ°æ ˆä¸­ã€‚ è¿™ç§ä¼˜åŒ–å‘ç”Ÿåœ¨`SIL`ç”Ÿæˆé˜¶æ®µã€‚

> Swiftä¸­é—´è¯­è¨€ï¼ˆSILï¼‰æ˜¯Swiftç‰¹æœ‰çš„é«˜çº§ä¸­é—´è¯­è¨€ï¼Œç”¨äºå¯¹Swiftä»£ç çš„è¿›ä¸€æ­¥åˆ†æå’Œä¼˜åŒ–ã€‚

ä¸‹é¢æ˜¯æˆ‘é€šè¿‡é˜…è¯»Swiftç¼–è¯‘å™¨æºä»£ç å‘ç°çš„ç¤ºä¾‹ã€‚

- predictable memory optimization https://github.com/apple/swift/blob/62ccf81f7748e3e2c8626354d1ecb3adbd26b063/lib/SILOptimizer/Mandatory/PredictableMemOpt.cpp
- closure capture promotion https://github.com/apple/swift/blob/31b167468793ec5b25a6c4e0769e2883d6125049/lib/SILOptimizer/IPO/CapturePromotion.cpp
- boxed values promotion https://github.com/apple/swift/blob/62ccf81f7748e3e2c8626354d1ecb3adbd26b063/lib/SILOptimizer/Transforms/AllocBoxToStack.cpp



### Swiftå€¼ç±»å‹ -- è£…ç®±

Swiftç¼–è¯‘å™¨å¯ä»¥å°†å€¼ç±»å‹è£…ç®±åæ”¾åˆ°å †ä¸Šã€‚ æˆ‘é€šè¿‡é˜…è¯»Swiftç¼–è¯‘å™¨æºä»£ç æ¥åˆ—å‡ºäº†ä¼šå‡ºç°çš„å‡ ç§æƒ…å†µã€‚

åœ¨ä»¥ä¸‹æƒ…å†µï¼Œå€¼ç±»å‹ä¼šè¢«è£…ç®±ï¼š

1. å½“å€¼ç±»å‹éµå¾ªäº†æŸä¸ªåè®®

   å½“å€¼ç±»å‹éµå¾ªäº†æŸä¸ªåè®®ï¼Œä¸”å­˜å‚¨åœ¨existentialï¼ˆå­˜åœ¨æ€§ï¼‰å®¹å™¨ä¸­è¶…è¿‡3ä¸ªæœºå™¨å­—é•¿æ—¶ï¼Œé™¤åˆ†é…æˆæœ¬å¤–ï¼Œè¿˜ä¼šäº§ç”Ÿé¢å¤–çš„å¼€é”€ã€‚

   

   Existential(å­˜åœ¨æ€§)å®¹å™¨æ˜¯ç”¨äºå­˜å‚¨è¿è¡Œæ—¶æœªçŸ¥ç±»å‹çš„å€¼çš„ä¸€ç§é€šç”¨å®¹å™¨ã€‚ è¾ƒå°çš„å€¼ç±»å‹å¯ä»¥å†…åµŒåœ¨å­˜åœ¨æ€§(existential)å®¹å™¨ä¸­ã€‚ è¾ƒå¤§çš„åˆ†é…åœ¨å †ä¸Šï¼Œ å®ƒä»¬çš„å¼•ç”¨å­˜å‚¨åœ¨å­˜åœ¨æ€§(existential)å®¹å™¨ç¼“å†²åŒºå†…ã€‚ æ­¤ç±»å€¼çš„ç”Ÿå­˜æœŸç”±`å€¼è§è¯è¡¨`(`Value Witness Table`)ç®¡ç†ã€‚ å½“è°ƒç”¨åè®®æ–¹æ³•æ—¶ä¼šäº§ç”Ÿå¼•ç”¨è®¡æ•°å’Œå‡ ä¸ªé—´æ¥çº§åˆ«çš„å¼€é”€ã€‚

   > å€¼è§è¯è¡¨(Value Witness Table): ä¸€ç§è¿è¡Œæ—¶ç»“æ„ï¼Œç”¨äºæè¿°å¦‚ä½•å¯¹æœªçŸ¥å€¼è¿›è¡Œâ€œ assignâ€ï¼Œâ€œ copyâ€å’Œâ€œ destroyâ€åŸºæœ¬æ“ä½œã€‚ ï¼ˆä¾‹å¦‚ï¼Œå¤åˆ¶æ­¤å€¼æ˜¯å¦éœ€è¦ä¿ç•™ï¼Ÿï¼‰
   >
   > è¯¦è§£è§å®˜æ–¹ï¼šhttps://github.com/apple/swift/blob/master/docs/Lexicon.rst

   

   è®©æˆ‘ä»¬çœ‹çœ‹ç”Ÿæˆçš„SILä»£ç ä»–ä»¬æ˜¯å¦‚ä½•è£…ç®±çš„ã€‚ æˆ‘ä»¬å£°æ˜ä¸€ä¸ªåè®®`Bar`å’Œä¸€ä¸ªç¬¦åˆå®ƒçš„ç»“æ„ä½“ `Baz`ï¼š

   ```
   protocol Bar {}
   struct Baz: Bar {}
   ```

   Swiftæ–‡ä»¶è½¬æ¢æˆSILè¯­è¨€çš„å‘½ä»¤æ˜¯ï¼š

   ```
   swiftc -emit-silgen -O main.swift
   ```


   è¾“å‡ºæ˜¾ç¤ºselfè¢«è£…åœ¨init()ä¸­ï¼š

   ```
   protocol Bar {
   }
   struct Baz : Bar {
     init()
   }
   // Baz.init()
   sil hidden [ossa] @$s6boxing3BazVACycfC : $@convention(method) (@thin Baz.Type) -> Baz {
   bb0(%0 : $@thin Baz.Type):
     %1 = alloc_box ${ var Baz }, var, name "self"   // user: %2
     ...
   }
   ```

   

2. å€¼ç±»å‹å’Œå¼•ç”¨ç±»å‹æ··åˆæ—¶

   ç»“æ„ä½“ä¸­åŒ…å«ç±»ï¼Œç±»ä¸­åŒ…å«ç»“æ„çš„æƒ…å†µå¾ˆå¸¸è§ï¼š

   ```
   // Class inside a struct
   class A {}
   struct B { 
     let a = A() 
   }
   
   // Struct inside a class
   struct C {}
   class D {
       let c = C()
   }
   ```

   `SIL`è¾“å‡ºæ˜¾ç¤ºï¼Œåœ¨ä¸¤ç§æƒ…å†µä¸‹ï¼Œç»“æ„`B`å’Œ`C`éƒ½åˆ†é…åœ¨å †ä¸Šï¼š

   ```
   // B.init()
   sil hidden [ossa] @$s6boxing1BVACycfC : $@convention(method) (@thin B.Type) -> @owned B {
   bb0(%0 : $@thin B.Type):
     %1 = alloc_box ${ var B }, var, name "self"     // user: %2
     ...
   }
   
   // C.init()
   sil hidden [ossa] @$s6boxing1CVACycfC : $@convention(method) (@thin C.Type) -> C {
   bb0(%0 : $@thin C.Type):
     %1 = alloc_box ${ var C }, var, name "self"     // user: %2
     ...
   }
   ```

   

3. å¸¦æœ‰æ³›å‹çš„å€¼ç±»å‹ã€‚

   è®©æˆ‘ä»¬å£°æ˜ä¸€ä¸ªå¸¦æ³›å‹çš„ç»“æ„ä½“ï¼š

   ```
   struct Bas<T> {
       var x: T
   
       init(xx: T) {
           x = xx
       }
   }
   ```

   `SIL`è¾“å‡ºæ˜¾ç¤ºselfè¢«è£…åœ¨initï¼ˆxx :)ä¸­ï¼š

   ```
   // Bas.init(xx:)
   bb0(%0 : $*Bas<T>, %1 : $*T, %2 : $@thin Bas<T>.Type):
     %3 = alloc_box $<Ï„_0_0> { var Bas<Ï„_0_0> } <T>, var, name "self" // user: %4
     ....
   }
   ```

4. é€ƒé¿é—­åŒ…æ•è·æ—¶ã€‚

   Swiftçš„é—­åŒ…å¯¹æ‰€æœ‰å±€éƒ¨å˜é‡éƒ½æ˜¯é€šè¿‡å¼•ç”¨æ¥æ•è·çš„ã€‚ å¦‚CapturePromotionä¸­æ‰€è¿°ï¼Œæœ‰äº›å¯èƒ½ä»è¢«æ”¾åœ¨æ ˆä¸­ã€‚

   > CapturePromotion https://github.com/apple/swift/blob/31b167468793ec5b25a6c4e0769e2883d6125049/lib/SILOptimizer/IPO/CapturePromotion.cpp

5. Inoutå‚æ•°

   è®©æˆ‘ä»¬ä¸º`foo(x :)`ç”Ÿæˆä¸€ä¸ªæ¥å—`inoutå‚æ•°`çš„SILï¼š

   ```
   func foo(x: inout Int) {
       x += 1
   }
   ```

   SILè¾“å‡ºæ˜¾ç¤ºfoo(x :)æ­£åœ¨è£…ç®±ï¼š

   ```
   // foo(x:)
   sil hidden [ossa] @$s6boxing3foo1xySiz_tF : $@convention(thin) (@inout Int) -> () {
   // %0                                             // users: %7, %1
   bb0(%0 : $*Int):
   ...
   }
   ```

### å¤åˆ¶çš„æˆæœ¬

ä¼—æ‰€å‘¨çŸ¥ï¼Œå¤§å¤šæ•°å€¼ç±»å‹éƒ½åˆ†é…åœ¨æ ˆä¸Šçš„ï¼Œå¤åˆ¶å®ƒä»¬éœ€è¦èŠ±è´¹å›ºå®šçš„æ—¶é—´ã€‚ å¤åˆ¶æ“ä½œé€Ÿåº¦å¿«çš„åŸå› æ˜¯æ•´æ•°å’Œæµ®ç‚¹æ•°ç­‰åŸºæœ¬æ•°æ®ç±»å‹å­˜å‚¨åœ¨CPUå¯„å­˜å™¨ä¸­ï¼Œå¤åˆ¶å®ƒä»¬æ—¶æ— éœ€è®¿é—®RAMå†…å­˜ã€‚ Swiftçš„å¤§å¤šæ•°å¯æ‰©å±•ç±»å‹ï¼ˆä¾‹å¦‚å­—ç¬¦ä¸²ï¼Œæ•°ç»„ï¼Œé›†åˆå’Œå­—å…¸ï¼‰éƒ½åœ¨å†™å…¥æ—¶è¢«å¤åˆ¶äº†ï¼ˆ copied on writeï¼‰ã€‚ è¿™æ„å‘³ç€å¤åˆ¶æ“ä½œæ¶ˆè€—å¾ˆå°ã€‚



ç”±äºå¼•ç”¨ç±»å‹ä¸ä¼šç›´æ¥å­˜å‚¨å…¶æ•°æ®ï¼Œå› æ­¤æˆ‘ä»¬åœ¨å¤åˆ¶å®ƒä»¬æ—¶åªä¼šäº§ç”Ÿå¼•ç”¨è®¡æ•°æˆæœ¬ã€‚ å¼•ç”¨è®¡æ•°çš„å¢åŠ å’Œå‡å°‘ä¸åƒæ•´æ•°å˜åŒ–é‚£ä¹ˆç®€å•ï¼Œè¿˜éœ€è¦é¢å¤–çš„èŠ±é”€ã€‚å› ä¸ºå †å¯èƒ½åŒæ—¶è¢«å¤šä¸ªçº¿ç¨‹å…±äº«ï¼Œä¸ºäº†ä¿æŒåŸå­æ€§ä¹Ÿéœ€è¦é¢å¤–èŠ±é”€ã€‚

> å…³äºARCçš„è®¨è®ºå’Œå †åˆ†é…å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸæˆ‘ä»¬å°†æ¥ä¼šå¼€ä¸“é¢˜è®¨è®ºï¼Œæ¬¢è¿å…³æ³¨å…¬ä¼—å·ï¼š`ä¹Coding`è·å–æœ€æ–°æ–‡ç« ã€‚



å½“æˆ‘ä»¬æ··åˆä½¿ç”¨å€¼å’Œå¼•ç”¨ç±»å‹æ—¶ï¼Œäº‹æƒ…å˜å¾—å¾ˆæœ‰è¶£ã€‚ å¦‚æœç»“æ„ä½“æˆ–æšä¸¾åŒ…å«å¼•ç”¨ç±»å‹æ—¶ï¼Œå®ƒä»¬éœ€è¦çš„å¼•ç”¨è®¡æ•°å¼€é”€ä¸ä»–ä»¬åŒ…å«å¼•ç”¨ç±»å‹çš„æ•°é‡æˆæ­£æ¯”ã€‚ ä¸‹é¢çš„ä»£ç ç¤ºä¾‹å¯ä»¥æœ€å¥½åœ°è¯æ˜è¿™ä¸€ç‚¹ã€‚ è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ‹¥æœ‰å¼•ç”¨ç±»å‹å±æ€§çš„ç»“æ„ä½“å’Œä¸€ä¸ªå…·æœ‰å¼•ç”¨ç±»å‹å±æ€§çš„ç±»ï¼Œå¹¶æ‰“å°ä»–ä»¬çš„å¼•ç”¨è®¡æ•°ã€‚

```
class Ref {}

// Struct with references
struct MyStruct {
    let ref1 = Ref()
    let ref2 = Ref()
}

// Class with references
class MyClass {
    let ref1 = Ref()
    let ref2 = Ref()
}
```

è®©æˆ‘ä»¬ä¸º`MyStruct`æ‰“å°å¼•ç”¨è®¡æ•°ï¼š

```
let a = MyStruct()
let anotherA = a
print("self:", CFGetRetainCount(a as CFTypeRef))
print("ref1:", CFGetRetainCount(a.ref1))
print("ref1:", CFGetRetainCount(a.ref2))
```

æ‰“å°ç»“æœï¼š

```
self: 1
ref1: 2
ref1: 2 
```

å†æ¥çœ‹çœ‹MyClass:

```
let b = MyClass()
let anotherB = b
print("self:", CFGetRetainCount(b))
print("ref1:", CFGetRetainCount(b.ref1))
print("ref1:", CFGetRetainCount(b.ref2))
```

æ‰“å°ï¼š

```
self: 2
ref1: 1
ref1: 1
```



è¾“å‡ºæ˜¾ç¤º`MyStruct`ç»“æ„ä½“äº§ç”Ÿäº†ä¸¤å€çš„å¼•ç”¨è®¡æ•°æˆæœ¬ğŸ˜±ã€‚

### ç»“æ„ä½“å’Œç±»çš„é€‰æ‹©

å¯¹äºåº”è¯¥ä½¿ç”¨ç±»è¿˜æ˜¯ç»“æ„ï¼Œæ²¡æœ‰ç®€å•çš„ç­”æ¡ˆã€‚ å°½ç®¡è‹¹æœå»ºè®®åœ¨å¯¹å…·æœ‰æ ‡è¯†ï¼ˆidentityï¼‰çš„ä¸œè¥¿ä½¿ç”¨ç±»ï¼Œå…¶ä»–æƒ…å†µä½¿ç”¨ç»“æ„ï¼Œä½†è¿™ä¸è¶³ä»¥æŒ‡å¯¼æˆ‘ä»¬åšå‡ºå†³å®šã€‚ ç”±äºæ¯ç§æƒ…å†µéƒ½ä¸åŒï¼Œæˆ‘ä»¬è¿˜éœ€è¦è™‘æ€§èƒ½ï¼š

- åº”å½“é¿å…å€¼ç±»å‹åŒ…å«å¼•ç”¨ç±»å‹çš„å˜é‡ï¼Œå› ä¸ºå®ƒä»¬è¿åäº†å€¼çš„è¯­ä¹‰å¹¶äº§ç”Ÿé¢å¤–çš„å¼•ç”¨è®¡æ•°å¼€é”€ã€‚
- å…·æœ‰åŠ¨æ€è¡Œä¸ºçš„å€¼ç±»å‹ï¼ˆä¾‹å¦‚æ•°ç»„å’Œå­—ç¬¦ä¸²ï¼‰åº”é‡‡ç”¨`copy-on-write`æ¥æ‘Šé”€å¤åˆ¶æˆæœ¬ã€‚
- å€¼ç±»å‹éµå¾ªåè®®æ—¶å°†è¢«è£…ç®±ï¼Œä»è€Œå¯¼è‡´æ›´é«˜çš„åˆ›å»ºæˆæœ¬ã€‚

æˆ‘ä»¬åº”è¯¥å°½é‡é¿å…ä»¥ä¸Šæƒ…å†µçš„å‘ç”Ÿï¼Œé™¤æ­¤ä¹‹å¤–å¯ä»¥æ ¹æ®ä½ çš„éœ€æ±‚é€‰æ‹©åˆé€‚çš„ç±»å‹ã€‚

------

![logo](https://upload-images.jianshu.io/upload_images/1159872-226e68e7b7afe00e?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
